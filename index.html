<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <form>
        <input type="text" autocomplete="off" placeholder="instance url" required>
        <input type="text" placeholder="ocr api key">
        <br>
        <label for="session">Session file</label>
        <br>
        <input type="file" id="session">
        <br><br>
        <input type="submit" value="Run axoBot"> <input type="button" value="disconect" id="disc" disabled>
    </form>
    <hr>
    <textarea id="console" style="width:100%;height:200px"></textarea>
</body>
<script>
    let ws,url,f,fr
    document.querySelector("form").addEventListener("submit",e=>{
        e.preventDefault()
        url = new URL(e.target[0].value)
        ocrapi=e.target[1].value
        // fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://labs.play-with-docker.com/sessions/'+e.target[0].value)}`)
        //             .then(response => {
        //               if (response.ok) return response.json()
        //               throw new Error('Network response was not ok.')
        //             })
        //             .then(data => console.log(data.contents));
        if (e.target[2].files){
            f = e.target[2].files[0]
            fr = new FileReader()
        }

        ws = new WebSocket(`wss://labs.play-with-docker.com/sessions/${url.pathname.substr(3)}/ws/`)
        const consl = document.getElementById("console"),
        disc = document.getElementById("disc")
        ws.onopen = e=>{
            disc.removeAttribute("disabled")
            if(f){
                fr.onload = e=>{
                    f = e.target.result.substr(37)
                    sendDat("base64 -d > axo_bot_docker.session <<EOF\n")
                    sendDat(f)
                    setTimeout(e=>{
                        sendDat("\nEOF\n")
                        nextstep()
                    },1000)
                    
                }
                fr.readAsDataURL(f)
            }else{
                sendDat("touch axo_bot_docker.session\n")
                nextstep()
            }
        }
        function nextstep(){
            setTimeout(e=>{
                sendDat(`docker run -i --mount type=bind,source=/root/axo_bot_docker.session,target=/app/axo_bot_docker.session gornostay25/axobot \"${(ocrapi)?ocrapi:""}\"\n`)
            },1000)
            
        }
        ws.onclose = e=>{
            alert("finished")
            location.reload()
        }
        ws.onerror = alert
        ws.onmessage = e=>{
            data = JSON.parse(e.data)
            if (data.name = "instance terminal out" && data.args[1]){
                consl.value+=data.args[1].replace(/[^\x00-\x7F]/g, "");
                consl.scrollTop = consl.scrollHeight;
            }
        }
    })

    function sendDat(text){
            ws.send(
                JSON.stringify(
                    {
                        name: "instance terminal in", 
                        args:[
                            url.hash.substr(1), 
                            text
                        ]
                    }
                )
            )
    }
</script>
</html>